---

title: ptypysql


keywords: fastai
sidebar: home_sidebar

summary: "A Python String SQL Formatter / Beautifier, built for PostgreSQL"
description: "A Python String SQL Formatter / Beautifier, built for PostgreSQL"
nb_path: "nbs/index.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-install">How to install<a class="anchor-link" href="#How-to-install"> </a></h2><p>Via pip</p>
<p><code>pip install ptypysql</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-use">How to use<a class="anchor-link" href="#How-to-use"> </a></h2><p>Currently it only supports for SQL in string format as <code>"""..."""</code> (Not work with<code>"..."</code>), and wrap by a function <code>DB.fetch_*(</code>, e.g.,</p>
<p><code>DB.fetch_all("""select * from table1 where id = 1""")</code></p>
<p>You can format SQL queries in python script via the command line</p>
<p><code>ptypysql sql.py</code></p>
<p>or format all your SQL queries in all python scripts under the same directory via</p>
<p><code>ptypysql *.py</code></p>
<p>Or even format all your SQL queries in the project recursively use</p>
<p><code>ptypysql -r "*.py"</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Controlling-maximum-length-line-via-truncation">Controlling maximum length line via truncation<a class="anchor-link" href="#Controlling-maximum-length-line-via-truncation"> </a></h3><p>The <code>ptypysql</code> will try to truncate too long lines based on the setting of max-line-length.</p>
<p>By default the maximum line length is 99.</p>
<p>You can control the maximum line length by:</p>
<p><code>ptypysql sql.py --max-line-length=50</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Usage-with-pre-commit">Usage with <code>pre-commit</code><a class="anchor-link" href="#Usage-with-pre-commit"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Add <code>ptypysql</code> as a hook to your <code>pre-commit</code> configuration to format your SQL files before commit, just add the following lines to your <code>.pre-commit-config.yaml</code>:</p>
<div class="highlight"><pre><span></span><span class="nt">repos</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/snapADDY/ptypysql</span><span class="w"></span>
<span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">master</span><span class="w"></span>
<span class="w">    </span><span class="nt">hooks</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ptypysql</span><span class="w"></span>
</pre></div>
<p>If you want to install <code>ptypysql</code> locally and use that instead of using <code>pre-commit</code>'s default environment, set <code>repo: local</code> in your <code>.pre-commit-config.yaml</code> file:</p>
<div class="highlight"><pre><span></span><span class="nt">repos</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span><span class="w"></span>
<span class="w">    </span><span class="nt">hooks</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ptypysql</span><span class="w"></span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pretty Python SQL</span><span class="w"></span>
<span class="w">      </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system</span><span class="w"></span>
<span class="w">      </span><span class="nt">entry</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ptypysql</span><span class="w"></span>
<span class="w">      </span><span class="nt">files</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">\.py$</span><span class="w"></span>
</pre></div>
<p>or</p>
<div class="highlight"><pre><span></span><span class="nt">repos</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span><span class="w"></span>
<span class="w">    </span><span class="nt">hooks</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ptypysql</span><span class="w"></span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pretty Python SQL</span><span class="w"></span>
<span class="w">      </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system</span><span class="w"></span>
<span class="w">      </span><span class="nt">entry</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ptypysql --max-line-length=50</span><span class="w"></span>
<span class="w">      </span><span class="nt">files</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">\.py$</span><span class="w"></span>
</pre></div>
<p>for a custom maximum line length truncation of e.g. 50</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Usage-in-Python">Usage in Python<a class="anchor-link" href="#Usage-in-Python"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can easily format the SQL string by:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">example_sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">WITH days AS (SELECT generate_series(date_trunc(&#39;day&#39;, now()) - &#39;90 days&#39;::interval, date_trunc(&#39;day&#39;, now()), &#39;1 day&#39;::interval) AS day)</span>
<span class="s2">select days.day as date, count(t1.id) count, count(t2.id) filter (where t2.id &lt; 500)</span>
<span class="s2">from days full outer join (select * from t3 where accd between 1 and 64) t1 on t1.date = days.day</span>
<span class="s2">natural left join t2 on t2.enddate = days.day</span>
<span class="s2">group by days.day desc having days.day &gt; 100 order by days.day desc;</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">ptypysql.core</span> <span class="kn">import</span> <span class="n">format_sql</span>
<span class="nb">print</span><span class="p">(</span><span class="n">format_sql</span><span class="p">(</span><span class="n">example_sql</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>WITH days AS (
    SELECT generate_series(
        date_trunc(&#39;day&#39;, now()) - &#39;90 days&#39;::interval,
        date_trunc(&#39;day&#39;, now()),
        &#39;1 day&#39;::interval
    ) AS day
)
SELECT days.day AS date,
    count(t1.id) AS count,
    count(t2.id) FILTER (
        WHERE t2.id &lt; 500
    )
FROM days
    FULL OUTER JOIN (
        SELECT *
        FROM t3
        WHERE accd BETWEEN 1 AND 64
    ) AS t1
        ON t1.date = days.day
    NATURAL LEFT JOIN t2
        ON t2.enddate = days.day
GROUP BY days.day DESC
HAVING days.day &gt; 100
ORDER BY days.day DESC;
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can also add <code>/*skip-formatter*/</code> to prevent from foramtting</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">ptypysql.format_file</span> <span class="kn">import</span> <span class="n">format_sql_commands</span>
<span class="nb">print</span><span class="p">(</span><span class="n">format_sql_commands</span><span class="p">(</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">/*skip-formatter*/</span>
<span class="sd">WITH days AS (SELECT generate_series(date_trunc(&#39;day&#39;, now()) - &#39;90 days&#39;::interval, date_trunc(&#39;day&#39;, now()), &#39;1 day&#39;::interval) AS day)</span>
<span class="sd">select days.day as date, count(t1.id) count, count(t2.id) filter (where t2.id &lt; 500) </span>
<span class="sd">from days full outer join (select * from t3 where accd between 1 and 64) t1 on t1.date = days.day</span>
<span class="sd">natural left join t2 on t2.enddate = days.day</span>
<span class="sd">group by days.day desc having days.day &gt; 100 order by days.day desc;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>/*skip-formatter*/
WITH days AS (SELECT generate_series(date_trunc(&#39;day&#39;, now()) - &#39;90 days&#39;::interval, date_trunc(&#39;day&#39;, now()), &#39;1 day&#39;::interval) AS day)
select days.day as date, count(t1.id) count, count(t2.id) filter (where t2.id &lt; 500) 
from days full outer join (select * from t3 where accd between 1 and 64) t1 on t1.date = days.day
natural left join t2 on t2.enddate = days.day
group by days.day desc having days.day &gt; 100 order by days.day desc;

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Credit">Credit<a class="anchor-link" href="#Credit"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This project makes use of and is based on:</p>
<ul>
<li><a href="https://github.com/PabloRMira/sql_formatter">SQL-formatter</a></li>
</ul>

</div>
</div>
</div>
</div>


